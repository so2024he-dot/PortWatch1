<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.portwatch.persistence.PortfolioDAO">

    <!-- ============================================ -->
    <!-- ResultMap 정의 -->
    <!-- ============================================ -->
    <resultMap id="PortfolioResultMap" type="com.portwatch.domain.PortfolioVO">
        <id property="portfolioId" column="portfolio_id" />
        <result property="memberId" column="member_id" />
        <result property="stockId" column="stock_id" />
        <result property="quantity" column="quantity" />
        <result property="avgPurchasePrice" column="avg_purchase_price" />
        <result property="purchaseDate" column="purchase_date" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />
        
        <!-- 종목 정보 조인 (선택사항) -->
        <result property="stockCode" column="stock_code" />
        <result property="stockName" column="stock_name" />
        <result property="marketType" column="market_type" />
        <result property="currentPrice" column="current_price" />
    </resultMap>

    <!-- ============================================ -->
    <!-- INSERT: 신규 포트폴리오 추가 -->
    <!-- ============================================ -->
    <insert id="insert" parameterType="com.portwatch.domain.PortfolioVO"
            useGeneratedKeys="true" keyProperty="portfolioId">
        INSERT INTO PORTFOLIO (
            member_id,
            stock_id,
            quantity,
            avg_purchase_price,
            purchase_date,
            created_at,
            updated_at
        ) VALUES (
            #{memberId},
            #{stockId},
            #{quantity},
            #{avgPurchasePrice},
            #{purchaseDate},
            NOW(),
            NOW()
        )
    </insert>

    <!-- ============================================ -->
    <!-- UPDATE: 추가 매입 시 수량/평균가 업데이트 -->
    <!-- ============================================ -->
    <update id="update" parameterType="com.portwatch.domain.PortfolioVO">
        UPDATE PORTFOLIO
        SET 
            quantity = #{quantity},
            avg_purchase_price = #{avgPurchasePrice},
            purchase_date = #{purchaseDate},
            updated_at = NOW()
        WHERE portfolio_id = #{portfolioId}
    </update>

    <!-- ============================================ -->
    <!-- DELETE: 포트폴리오 삭제 -->
    <!-- ============================================ -->
    <delete id="delete" parameterType="int">
        DELETE FROM PORTFOLIO
        WHERE portfolio_id = #{portfolioId}
    </delete>

    <!-- ============================================ -->
    <!-- SELECT: 회원의 전체 포트폴리오 조회 -->
    <!-- ============================================ -->
    <select id="selectByMember" parameterType="int" resultMap="PortfolioResultMap">
        SELECT 
            p.portfolio_id,
            p.member_id,
            p.stock_id,
            p.quantity,
            p.avg_purchase_price,
            p.purchase_date,
            p.created_at,
            p.updated_at,
            s.stock_code,
            s.stock_name,
            s.market_type,
            s.current_price
        FROM PORTFOLIO p
        INNER JOIN STOCK s ON p.stock_id = s.stock_id
        WHERE p.member_id = #{memberId}
        ORDER BY p.updated_at DESC
    </select>

    <!-- ============================================ -->
    <!-- SELECT: 특정 포트폴리오 조회 -->
    <!-- ============================================ -->
    <select id="selectById" parameterType="int" resultMap="PortfolioResultMap">
        SELECT 
            p.portfolio_id,
            p.member_id,
            p.stock_id,
            p.quantity,
            p.avg_purchase_price,
            p.purchase_date,
            p.created_at,
            p.updated_at,
            s.stock_code,
            s.stock_name,
            s.market_type,
            s.current_price
        FROM PORTFOLIO p
        INNER JOIN STOCK s ON p.stock_id = s.stock_id
        WHERE p.portfolio_id = #{portfolioId}
    </select>

    <!-- ============================================ -->
    <!-- SELECT: 회원의 특정 종목 보유 여부 확인 -->
    <!-- 추가 매입 시 기존 보유 여부 확인용 -->
    <!-- ============================================ -->
    <select id="selectByMemberAndStock" parameterType="map" resultMap="PortfolioResultMap">
        SELECT 
            p.portfolio_id,
            p.member_id,
            p.stock_id,
            p.quantity,
            p.avg_purchase_price,
            p.purchase_date,
            p.created_at,
            p.updated_at,
            s.stock_code,
            s.stock_name,
            s.market_type,
            s.current_price
        FROM PORTFOLIO p
        INNER JOIN STOCK s ON p.stock_id = s.stock_id
        WHERE p.member_id = #{memberId}
          AND p.stock_id = #{stockId}
        LIMIT 1
    </select>

</mapper>
