<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.portwatch.persistence.PortfolioDAO">

    <!-- ============================================ -->
    <!-- ResultMap 정의 (현재 MySQL DDL에 맞춤) -->
    <!-- ============================================ -->
    <resultMap id="PortfolioResultMap" type="PortfolioVO">
        <id property="portfolioId" column="portfolio_id"/>
        <result property="memberId" column="member_id"/>
        <result property="stockId" column="stock_id"/>
        <result property="quantity" column="quantity"/>
        <result property="avgPurchasePrice" column="avg_purchase_price"/>
        <result property="purchaseDate" column="purchase_date"/>
        <result property="updatedAt" column="updated_at"/>
        
        <!-- STOCK 조인 -->
        <result property="stockCode" column="stock_code"/>
        <result property="stockName" column="stock_name"/>
        <result property="marketType" column="market_type"/>
        <result property="industry" column="industry"/>
        
        <!-- STOCK_PRICE 조인 -->
        <result property="currentPrice" column="current_price"/>
    </resultMap>

    <!-- ============================================ -->
    <!-- 포트폴리오 추가 -->
    <!-- ============================================ -->
    <insert id="insertPortfolio" parameterType="PortfolioVO">
        INSERT INTO PORTFOLIO (
            member_id,
            stock_id,
            stock_code,
            stock_name,
            quantity,
            avg_purchase_price,
            purchase_date
        )
        SELECT 
            #{memberId},
            #{stockId},
            s.stock_code,
            s.stock_name,
            #{quantity},
            #{avgPurchasePrice},
            #{purchaseDate}
        FROM STOCK s
        WHERE s.stock_id = #{stockId}
    </insert>

    
    <!-- ============================================ -->
    <!-- 회원의 포트폴리오 목록 조회 -->
    <!-- ============================================ -->
    <select id="selectPortfolioByMember" parameterType="int" resultMap="PortfolioResultMap">
        SELECT 
            p.portfolio_id,
            p.member_id,
            p.stock_id,
            p.quantity,
            p.avg_purchase_price,
            p.purchase_date,
            p.updated_at,
            s.stock_code,
            s.stock_name,
            s.market_type,
            s.industry,
            sp.close_price as current_price
        FROM PORTFOLIO p
        INNER JOIN STOCK s ON p.stock_id = s.stock_id
        LEFT JOIN (
            SELECT 
                stock_id, 
                close_price,
                ROW_NUMBER() OVER (PARTITION BY stock_id ORDER BY trade_date DESC) as rn
            FROM STOCK_PRICE
        ) sp ON s.stock_id = sp.stock_id AND sp.rn = 1
        WHERE p.member_id = #{memberId}
        ORDER BY s.stock_name
    </select>
    
    <!-- ============================================ -->
    <!-- 포트폴리오 ID로 조회 -->
    <!-- ============================================ -->
    <select id="selectPortfolioById" parameterType="long" resultMap="PortfolioResultMap">
        SELECT 
            p.portfolio_id,
            p.member_id,
            p.stock_id,
            p.quantity,
            p.avg_purchase_price,
            p.purchase_date,
            p.updated_at,
            s.stock_code,
            s.stock_name,
            s.market_type,
            s.industry,
            sp.close_price as current_price
        FROM PORTFOLIO p
        INNER JOIN STOCK s ON p.stock_id = s.stock_id
        LEFT JOIN (
            SELECT 
                stock_id, 
                close_price,
                ROW_NUMBER() OVER (PARTITION BY stock_id ORDER BY trade_date DESC) as rn
            FROM STOCK_PRICE
        ) sp ON s.stock_id = sp.stock_id AND sp.rn = 1
        WHERE p.portfolio_id = #{portfolioId}
    </select>
    
    <!-- ============================================ -->
    <!-- 중복 확인 (회원 + 종목) -->
    <!-- ============================================ -->
    <select id="checkDuplicate" resultType="int">
        SELECT COUNT(*)
        FROM PORTFOLIO
        WHERE member_id = #{memberId}
          AND stock_id = #{stockId}
    </select>
    
    <!-- ============================================ -->
    <!-- 포트폴리오 수정 -->
    <!-- ============================================ -->
    <update id="updatePortfolio" parameterType="PortfolioVO">
        UPDATE PORTFOLIO
        SET
            quantity = #{quantity},
            avg_purchase_price = #{avgPurchasePrice},
            purchase_date = #{purchaseDate}
        WHERE portfolio_id = #{portfolioId}
    </update>
    
    <!-- ============================================ -->
    <!-- 포트폴리오 삭제 -->
    <!-- ============================================ -->
    <delete id="deletePortfolio" parameterType="long">
        DELETE FROM PORTFOLIO
        WHERE portfolio_id = #{portfolioId}
    </delete>
    
    <!-- ============================================ -->
    <!-- 포트폴리오 요약 (총 투자금액, 평가금액, 손익, 수익률) -->
    <!-- ============================================ -->
    <select id="getPortfolioSummary" parameterType="int" resultType="map">
        SELECT 
            COUNT(DISTINCT p.stock_id) as stockCount,
            COALESCE(SUM(p.quantity * p.avg_purchase_price), 0) as totalInvestment,
            COALESCE(SUM(p.quantity * sp.close_price), 0) as totalValue,
            COALESCE(SUM(p.quantity * (sp.close_price - p.avg_purchase_price)), 0) as totalProfit,
            CASE 
                WHEN SUM(p.quantity * p.avg_purchase_price) > 0 THEN
                    ROUND((SUM(p.quantity * (sp.close_price - p.avg_purchase_price)) / 
                           SUM(p.quantity * p.avg_purchase_price)) * 100, 2)
                ELSE 0
            END as totalProfitRate
        FROM PORTFOLIO p
        LEFT JOIN (
            SELECT 
                stock_id, 
                close_price,
                ROW_NUMBER() OVER (PARTITION BY stock_id ORDER BY trade_date DESC) as rn
            FROM STOCK_PRICE
        ) sp ON p.stock_id = sp.stock_id AND sp.rn = 1
        WHERE p.member_id = #{memberId}
    </select>

</mapper>
