<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
NEWS MAPPER - 완벽 수정
Spring 5.0.7 + MySQL 8.0.33 + MyBatis 3.4.6

추가된 메서드:
- selectRecentNews: 최근 뉴스 조회 (limit)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
-->

<mapper namespace="com.portwatch.persistence.NewsDAO">
    
    <!-- ✅ 최근 뉴스 조회 (신규 추가) -->
    <select id="selectRecentNews" parameterType="int" resultType="NewsVO">
        SELECT 
            news_id,
            stock_code,
            news_title,
            news_content,
            news_url,
            published_date,
            source,
            created_at
        FROM news
        ORDER BY published_date DESC, created_at DESC
        LIMIT #{limit}
    </select>
    
    <!-- ✅ 모든 뉴스 조회 -->
    <select id="selectAllNews" resultType="NewsVO">
        SELECT 
            news_id,
            stock_code,
            news_title,
            news_content,
            news_url,
            published_date,
            source,
            created_at
        FROM news
        ORDER BY published_date DESC
    </select>
    
    <!-- ✅ 특정 주식 뉴스 조회 -->
    <select id="selectNewsByStock" parameterType="map" resultType="NewsVO">
        SELECT 
            news_id,
            stock_code,
            news_title,
            news_content,
            news_url,
            published_date,
            source,
            created_at
        FROM news
        WHERE stock_code = #{stockCode}
        ORDER BY published_date DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>
    
    <!-- ✅ 뉴스 상세 조회 -->
    <select id="selectNewsById" parameterType="long" resultType="NewsVO">
        SELECT 
            news_id,
            stock_code,
            news_title,
            news_content,
            news_url,
            published_date,
            source,
            created_at
        FROM news
        WHERE news_id = #{newsId}
    </select>
    
    <!-- ✅ 뉴스 삽입 -->
    <insert id="insertNews" parameterType="NewsVO">
        INSERT INTO news (
            stock_code,
            news_title,
            news_content,
            news_url,
            published_date,
            source,
            created_at
        ) VALUES (
            #{stockCode},
            #{newsTitle},
            #{newsContent},
            #{newsUrl},
            #{publishedDate},
            #{source},
            NOW()
        )
    </insert>
    
    <!-- ✅ 뉴스 수정 -->
    <update id="updateNews" parameterType="NewsVO">
        UPDATE news
        SET 
            stock_code = #{stockCode},
            news_title = #{newsTitle},
            news_content = #{newsContent},
            news_url = #{newsUrl},
            published_date = #{publishedDate},
            source = #{source}
        WHERE news_id = #{newsId}
    </update>
    
    <!-- ✅ 뉴스 삭제 -->
    <delete id="deleteNews" parameterType="long">
        DELETE FROM news
        WHERE news_id = #{newsId}
    </delete>
    
    <!-- ✅ 총 뉴스 개수 -->
    <select id="countNews" resultType="int">
        SELECT COUNT(*)
        FROM news
    </select>
    
    <!-- ✅ 주식별 뉴스 개수 -->
    <select id="countNewsByStock" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM news
        WHERE stock_code = #{stockCode}
    </select>
    
</mapper>
