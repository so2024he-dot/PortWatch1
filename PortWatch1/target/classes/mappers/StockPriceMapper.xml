<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.portwatch.persistence.StockPriceDAO">

    <!-- ResultMap -->
    <resultMap id="StockPriceResultMap" type="com.portwatch.domain.StockPriceVO">
        <id property="priceId" column="price_id"/>
        <result property="stockId" column="stock_id"/>
        <result property="tradeDate" column="trade_date"/>
        <result property="openPrice" column="open_price"/>
        <result property="highPrice" column="high_price"/>
        <result property="lowPrice" column="low_price"/>
        <result property="closePrice" column="close_price"/>
        <result property="volume" column="volume"/>
        <result property="tradingValue" column="trading_value"/>
    </resultMap>

    <!-- 주가 정보 삽입 -->
    <insert id="insertStockPrice" parameterType="com.portwatch.domain.StockPriceVO">
        INSERT INTO STOCK_PRICE (
            stock_id,
            trade_date,
            open_price,
            high_price,
            low_price,
            close_price,
            volume,
            trading_value
        ) VALUES (
            #{stockId},
            #{tradeDate},
            #{openPrice},
            #{highPrice},
            #{lowPrice},
            #{closePrice},
            #{volume},
            #{tradingValue}
        )
    </insert>

    <!-- 주가 정보 업데이트 -->
    <update id="updateStockPrice" parameterType="com.portwatch.domain.StockPriceVO">
        UPDATE STOCK_PRICE
        SET open_price = #{openPrice},
            high_price = #{highPrice},
            low_price = #{lowPrice},
            close_price = #{closePrice},
            volume = #{volume},
            trading_value = #{tradingValue}
        WHERE stock_id = #{stockId}
          AND trade_date = #{tradeDate}
    </update>

    <!-- UPSERT: INSERT ON DUPLICATE KEY UPDATE -->
    <insert id="upsertStockPrice" parameterType="com.portwatch.domain.StockPriceVO">
        INSERT INTO STOCK_PRICE (
            stock_id,
            trade_date,
            open_price,
            high_price,
            low_price,
            close_price,
            volume,
            trading_value
        ) VALUES (
            #{stockId},
            #{tradeDate},
            #{openPrice},
            #{highPrice},
            #{lowPrice},
            #{closePrice},
            #{volume},
            #{tradingValue}
        )
        ON DUPLICATE KEY UPDATE
            open_price = VALUES(open_price),
            high_price = VALUES(high_price),
            low_price = VALUES(low_price),
            close_price = VALUES(close_price),
            volume = VALUES(volume),
            trading_value = VALUES(trading_value)
    </insert>

    <!-- 특정 종목의 최신 주가 조회 -->
    <select id="selectLatestByStockId" parameterType="int" resultMap="StockPriceResultMap">
        SELECT 
            price_id,
            stock_id,
            trade_date,
            open_price,
            high_price,
            low_price,
            close_price,
            volume,
            trading_value
        FROM STOCK_PRICE
        WHERE stock_id = #{stockId}
        ORDER BY trade_date DESC
        LIMIT 1
    </select>

    <!-- 특정 종목의 특정 날짜 주가 조회 -->
    <select id="selectByStockIdAndDate" resultMap="StockPriceResultMap">
        SELECT 
            price_id,
            stock_id,
            trade_date,
            open_price,
            high_price,
            low_price,
            close_price,
            volume,
            trading_value
        FROM STOCK_PRICE
        WHERE stock_id = #{stockId}
          AND trade_date = #{tradeDate}
    </select>

    <!-- 특정 종목의 주가 히스토리 조회 (최근 N일) -->
    <select id="selectPriceHistory" resultMap="StockPriceResultMap">
        SELECT 
            price_id,
            stock_id,
            trade_date,
            open_price,
            high_price,
            low_price,
            close_price,
            volume,
            trading_value
        FROM STOCK_PRICE
        WHERE stock_id = #{stockId}
          AND trade_date >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        ORDER BY trade_date DESC
        LIMIT #{days}
    </select>

    <!-- 오늘 날짜에 업데이트된 종목 수 조회 -->
    <select id="countTodayUpdates" resultType="int">
        SELECT COUNT(DISTINCT stock_id)
        FROM STOCK_PRICE
        WHERE trade_date = CURDATE()
    </select>

    <!-- 주가 정보 삭제 (특정 날짜 이전) -->
    <delete id="deletePricesBeforeDate" parameterType="java.sql.Date">
        DELETE FROM STOCK_PRICE
        WHERE trade_date <![CDATA[<]]> #{beforeDate}
    </delete>

	<!-- 종목 코드로 조회 -->
	<select id="selectByStockCode" parameterType="string" resultType="com.portwatch.domain.StockVO">
	    SELECT 
	        stock_id AS stockId,
	        stock_code AS stockCode,
	        stock_name AS stockName,
	        market_type AS marketType,
	        industry
	    FROM STOCK
	    WHERE stock_code = #{stockCode}
	</select>
	
	<!-- 전체 종목 목록 조회 -->
	<select id="selectAllStocks" resultType="com.portwatch.domain.StockVO">
	    SELECT 
	        stock_id AS stockId,
	        stock_code AS stockCode,
	        stock_name AS stockName,
	        market_type AS marketType,
	        industry
	    FROM STOCK
	    ORDER BY stock_code
	    
</select>
	
</mapper>
