<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
WATCHLIST MAPPER - 완벽 수정
Spring 5.0.7 + MySQL 8.0.33 + MyBatis 3.4.6

수정 내용:
- WATCHLIST → watchlist (소문자)
- STOCK → stock (소문자)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
-->

<mapper namespace="com.portwatch.persistence.WatchlistDAO">
    
    <!-- ✅ 회원 ID로 관심종목 조회 (소문자 테이블명) -->
    <select id="selectByMemberId" parameterType="string" resultType="WatchlistVO">
        SELECT 
            w.watchlist_id,
            w.member_id,
            w.stock_code,
            w.created_at,
            s.stock_name,
            s.current_price,
            s.market_type,
            s.country
        FROM watchlist w
        LEFT JOIN stock s ON w.stock_code = s.stock_code
        WHERE w.member_id = #{memberId}
        ORDER BY w.created_at DESC
    </select>
    
    <!-- ✅ 관심종목 추가 -->
    <insert id="insertWatchlist" parameterType="WatchlistVO">
        INSERT INTO watchlist (
            member_id,
            stock_code,
            created_at
        ) VALUES (
            #{memberId},
            #{stockCode},
            NOW()
        )
    </insert>
    
    <!-- ✅ 관심종목 삭제 -->
    <delete id="deleteWatchlist" parameterType="long">
        DELETE FROM watchlist
        WHERE watchlist_id = #{watchlistId}
    </delete>
    
    <!-- ✅ 회원ID + 종목코드로 관심종목 조회 -->
    <select id="selectByMemberAndStock" parameterType="map" resultType="WatchlistVO">
        SELECT 
            watchlist_id,
            member_id,
            stock_code,
            created_at
        FROM watchlist
        WHERE member_id = #{memberId}
        AND stock_code = #{stockCode}
    </select>
    
    <!-- ✅ 관심종목 개수 조회 -->
    <select id="countWatchlist" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM watchlist
        WHERE member_id = #{memberId}
    </select>
    
    <!-- ✅ 관심종목 존재 여부 확인 -->
    <select id="existsWatchlist" parameterType="map" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM watchlist
        WHERE member_id = #{memberId}
        AND stock_code = #{stockCode}
    </select>
    
    <!-- ✅ 모든 관심종목 조회 -->
    <select id="selectAllWatchlist" resultType="WatchlistVO">
        SELECT 
            w.watchlist_id,
            w.member_id,
            w.stock_code,
            w.created_at,
            s.stock_name,
            s.current_price,
            s.market_type,
            s.country
        FROM watchlist w
        LEFT JOIN stock s ON w.stock_code = s.stock_code
        ORDER BY w.created_at DESC
    </select>
    
</mapper>
