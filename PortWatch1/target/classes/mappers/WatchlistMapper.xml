<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.portwatch.persistence.WatchlistDAO">

    <!-- ========================================
         ResultMap 정의
         ======================================== -->
    
    <resultMap id="WatchlistResultMap" type="WatchlistVO">
        <id property="watchlistId" column="watchlist_id"/>
        <result property="memberId" column="member_id"/>
        <result property="stockCode" column="stock_code"/>
        <result property="createdAt" column="created_at"/>
        <!-- 조인 시 사용할 추가 필드 -->
        <result property="stockName" column="stock_name"/>
        <result property="currentPrice" column="current_price"/>
        <result property="marketType" column="market_type"/>
        <result property="country" column="country"/>
    </resultMap>

    <!-- ========================================
         기본 CRUD
         ======================================== -->
    
    <!-- 회원의 관심종목 목록 조회 (주식 정보 포함) -->
    <select id="selectByMemberId" parameterType="string" resultMap="WatchlistResultMap">
        SELECT 
            w.watchlist_id,
            w.member_id,
            w.stock_code,
            w.created_at,
            s.stock_name,
            s.current_price,
            s.market_type,
            s.country
        FROM WATCHLIST w
        LEFT JOIN STOCK s ON w.stock_code = s.stock_code
        WHERE w.member_id = #{memberId}
        ORDER BY w.created_at DESC
    </select>
    
    <!-- 특정 관심종목 조회 (회원 + 종목 코드) -->
    <select id="selectByMemberAndStock" resultMap="WatchlistResultMap">
        SELECT 
            w.watchlist_id,
            w.member_id,
            w.stock_code,
            w.created_at,
            s.stock_name,
            s.current_price,
            s.market_type,
            s.country
        FROM WATCHLIST w
        LEFT JOIN STOCK s ON w.stock_code = s.stock_code
        WHERE w.member_id = #{memberId}
          AND w.stock_code = #{stockCode}
    </select>
    
    <!-- 관심종목 추가 -->
    <insert id="insert" parameterType="WatchlistVO" useGeneratedKeys="true" keyProperty="watchlistId">
        INSERT INTO WATCHLIST (
            member_id,
            stock_code,
            created_at
        ) VALUES (
            #{memberId},
            #{stockCode},
            NOW()
        )
    </insert>
    
    <!-- 관심종목 삭제 (ID로) -->
    <delete id="deleteById" parameterType="long">
        DELETE FROM WATCHLIST
        WHERE watchlist_id = #{watchlistId}
    </delete>
    
    <!-- 관심종목 삭제 (회원 + 종목 코드) -->
    <delete id="delete">
        DELETE FROM WATCHLIST
        WHERE member_id = #{memberId}
          AND stock_code = #{stockCode}
    </delete>
    
    <!-- 회원의 모든 관심종목 삭제 -->
    <delete id="deleteByMemberId" parameterType="string">
        DELETE FROM WATCHLIST
        WHERE member_id = #{memberId}
    </delete>

    <!-- ========================================
         통계 쿼리
         ======================================== -->
    
    <!-- 회원의 관심종목 개수 -->
    <select id="count" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM WATCHLIST
        WHERE member_id = #{memberId}
    </select>
    
    <!-- 특정 종목을 관심종목으로 추가한 회원 수 -->
    <select id="countByStockCode" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM WATCHLIST
        WHERE stock_code = #{stockCode}
    </select>
    
    <!-- 관심종목 여부 확인 -->
    <select id="exists" resultType="int">
        SELECT COUNT(*)
        FROM WATCHLIST
        WHERE member_id = #{memberId}
          AND stock_code = #{stockCode}
    </select>

    <!-- ========================================
         고급 쿼리
         ======================================== -->
    
    <!-- 특정 국가의 관심종목만 조회 -->
    <select id="selectByMemberIdAndCountry" resultMap="WatchlistResultMap">
        SELECT 
            w.watchlist_id,
            w.member_id,
            w.stock_code,
            w.created_at,
            s.stock_name,
            s.current_price,
            s.market_type,
            s.country
        FROM WATCHLIST w
        LEFT JOIN STOCK s ON w.stock_code = s.stock_code
        WHERE w.member_id = #{memberId}
          AND s.country = #{country}
        ORDER BY w.created_at DESC
    </select>
    
    <!-- 특정 시장의 관심종목만 조회 -->
    <select id="selectByMemberIdAndMarket" resultMap="WatchlistResultMap">
        SELECT 
            w.watchlist_id,
            w.member_id,
            w.stock_code,
            w.created_at,
            s.stock_name,
            s.current_price,
            s.market_type,
            s.country
        FROM WATCHLIST w
        LEFT JOIN STOCK s ON w.stock_code = s.stock_code
        WHERE w.member_id = #{memberId}
          AND s.market_type = #{marketType}
        ORDER BY w.created_at DESC
    </select>
    
    <!-- 최근 추가된 관심종목 조회 (N개) -->
    <select id="selectRecentByMemberId" resultMap="WatchlistResultMap">
        SELECT 
            w.watchlist_id,
            w.member_id,
            w.stock_code,
            w.created_at,
            s.stock_name,
            s.current_price,
            s.market_type,
            s.country
        FROM WATCHLIST w
        LEFT JOIN STOCK s ON w.stock_code = s.stock_code
        WHERE w.member_id = #{memberId}
        ORDER BY w.created_at DESC
        LIMIT #{limit}
    </select>

</mapper>
