<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.portwatch.persistence.PaymentDAO">

    <!-- ============================================ -->
    <!-- ResultMap 정의 -->
    <!-- ============================================ -->
    <resultMap id="PaymentResultMap" type="PaymentVO">
        <id property="paymentId" column="payment_id"/>
        <result property="memberId" column="member_id"/>
        <result property="portfolioId" column="portfolio_id"/>
        <result property="stockId" column="stock_id"/>
        <result property="stockCode" column="stock_code"/>
        <result property="stockName" column="stock_name"/>
        <result property="quantity" column="quantity"/>
        <result property="purchasePrice" column="purchase_price"/>
        <result property="totalAmount" column="total_amount"/>
        <result property="paymentMethod" column="payment_method"/>
        <result property="cardNumber" column="card_number"/>
        <result property="cardCompany" column="card_company"/>
        <result property="bankName" column="bank_name"/>
        <result property="paymentStatus" column="payment_status"/>
        <result property="transactionId" column="transaction_id"/>
        <result property="pgProvider" column="pg_provider"/>
        <result property="country" column="country"/>
        <result property="currency" column="currency"/>
        <result property="exchangeRate" column="exchange_rate"/>
        <result property="localAmount" column="local_amount"/>
        <result property="createdAt" column="created_at"/>
        <result property="paidAt" column="paid_at"/>
        <result property="cancelledAt" column="cancelled_at"/>
        <result property="memo" column="memo"/>
        <result property="receiptUrl" column="receipt_url"/>
    </resultMap>

    <!-- ============================================ -->
    <!-- 1. 결제 정보 등록 -->
    <!-- ============================================ -->
    <insert id="insertPayment" parameterType="PaymentVO" useGeneratedKeys="true" keyProperty="paymentId">
        INSERT INTO PAYMENT (
            member_id,
            stock_id,
            stock_code,
            stock_name,
            quantity,
            purchase_price,
            total_amount,
            payment_method,
            card_number,
            card_company,
            bank_name,
            payment_status,
            pg_provider,
            country,
            currency,
            exchange_rate,
            local_amount,
            memo
        ) VALUES (
            #{memberId},
            #{stockId},
            #{stockCode},
            #{stockName},
            #{quantity},
            #{purchasePrice},
            #{totalAmount},
            #{paymentMethod},
            #{cardNumber},
            #{cardCompany},
            #{bankName},
            #{paymentStatus},
            #{pgProvider},
            #{country},
            #{currency},
            #{exchangeRate},
            #{localAmount},
            #{memo}
        )
    </insert>

    <!-- ============================================ -->
    <!-- 2. 결제 ID로 조회 -->
    <!-- ============================================ -->
    <select id="selectPaymentById" parameterType="long" resultMap="PaymentResultMap">
        SELECT * FROM PAYMENT
        WHERE payment_id = #{paymentId}
    </select>

    <!-- ============================================ -->
    <!-- 3. 회원의 결제 내역 조회 -->
    <!-- ============================================ -->
    <select id="selectPaymentsByMember" parameterType="int" resultMap="PaymentResultMap">
        SELECT * FROM PAYMENT
        WHERE member_id = #{memberId}
        ORDER BY created_at DESC
    </select>

    <!-- ============================================ -->
    <!-- 4. 결제 상태 업데이트 -->
    <!-- ============================================ -->
    <update id="updatePaymentStatus">
        UPDATE PAYMENT
        SET payment_status = #{status},
            transaction_id = #{transactionId},
            paid_at = CASE WHEN #{status} = 'COMPLETED' THEN NOW() ELSE paid_at END
        WHERE payment_id = #{paymentId}
    </update>

    <!-- ============================================ -->
    <!-- 5. 결제 완료 처리 -->
    <!-- ============================================ -->
    <update id="completePayment">
        UPDATE PAYMENT
        SET payment_status = 'COMPLETED',
            portfolio_id = #{portfolioId},
            transaction_id = #{transactionId},
            paid_at = NOW()
        WHERE payment_id = #{paymentId}
    </update>

    <!-- ============================================ -->
    <!-- 6. 결제 취소 -->
    <!-- ============================================ -->
    <update id="cancelPayment" parameterType="long">
        UPDATE PAYMENT
        SET payment_status = 'CANCELLED',
            cancelled_at = NOW()
        WHERE payment_id = #{paymentId}
    </update>

    <!-- ============================================ -->
    <!-- 7. 회원의 결제 요약 정보 -->
    <!-- ============================================ -->
    <select id="getPaymentSummary" parameterType="int" resultType="map">
        SELECT 
            COUNT(*) as totalPayments,
            SUM(CASE WHEN payment_status = 'COMPLETED' THEN 1 ELSE 0 END) as completedPayments,
            SUM(CASE WHEN payment_status = 'COMPLETED' THEN total_amount ELSE 0 END) as totalAmount,
            AVG(CASE WHEN payment_status = 'COMPLETED' THEN total_amount ELSE NULL END) as avgPayment
        FROM PAYMENT
        WHERE member_id = #{memberId}
    </select>

    <!-- ============================================ -->
    <!-- 8. 국가별 결제 통계 -->
    <!-- ============================================ -->
    <select id="getPaymentStatsByCountry" resultType="map">
        SELECT 
            country,
            currency,
            COUNT(*) as paymentCount,
            SUM(total_amount) as totalSales,
            AVG(total_amount) as avgPayment
        FROM PAYMENT
        WHERE payment_status = 'COMPLETED'
        GROUP BY country, currency
        ORDER BY totalSales DESC
    </select>

    <!-- ============================================ -->
    <!-- 9. 최근 결제 내역 조회 -->
    <!-- ============================================ -->
    <select id="selectRecentPayments" resultMap="PaymentResultMap">
        SELECT * FROM PAYMENT
        WHERE payment_status = 'COMPLETED'
        ORDER BY paid_at DESC
        LIMIT #{limit}
    </select>

</mapper>
