<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.portwatch.persistence.WatchlistDAO">

    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         Result Map
         ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    
    <resultMap id="WatchlistResultMap" type="com.portwatch.domain.WatchlistVO">
        <id property="watchlistId" column="watchlist_id"/>
        <result property="memberId" column="member_id"/>
        <result property="stockCode" column="stock_code"/>
        <result property="createdAt" column="created_at"/>
        
        <!-- Stock 정보 (LEFT JOIN) -->
        <result property="stockName" column="stock_name"/>
        <result property="currentPrice" column="current_price"/>
        <result property="marketType" column="market_type"/>
        <result property="country" column="country"/>
    </resultMap>

    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         ✅ 관심종목 추가 (INSERT)
         ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    
    <insert id="insert" parameterType="com.portwatch.domain.WatchlistVO">
        INSERT INTO watchlist (
            member_id,
            stock_code,
            created_at
        ) VALUES (
            #{memberId},
            #{stockCode},
            NOW()
        )
    </insert>

    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         ✅ 중복 확인 (SELECT COUNT)
         ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    
    <select id="existsByMemberAndStock" resultType="int">
        SELECT COUNT(*) 
        FROM watchlist 
        WHERE member_id = #{memberId} 
          AND stock_code = #{stockCode}
    </select>

    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         ✅ 관심종목 삭제 (DELETE)
         ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    
    <delete id="deleteByMemberAndStock">
        DELETE FROM watchlist 
        WHERE member_id = #{memberId} 
          AND stock_code = #{stockCode}
    </delete>

    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         회원별 관심종목 목록 조회 (Stock 정보 포함)
         ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    
    <select id="selectByMemberId" parameterType="string" resultMap="WatchlistResultMap">
        SELECT 
            w.watchlist_id,
            w.member_id,
            w.stock_code,
            w.created_at,
            s.stock_name,
            s.current_price,
            s.market_type,
            s.country
        FROM watchlist w
        LEFT JOIN stock s ON w.stock_code = s.stock_code
        WHERE w.member_id = #{memberId}
        ORDER BY w.created_at DESC
    </select>

    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         회원별 관심종목 개수 조회
         ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    
    <select id="countByMemberId" parameterType="string" resultType="int">
        SELECT COUNT(*) 
        FROM watchlist 
        WHERE member_id = #{memberId}
    </select>

    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         관심종목 ID로 조회
         ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    
    <select id="selectById" parameterType="long" resultMap="WatchlistResultMap">
        SELECT 
            w.watchlist_id,
            w.member_id,
            w.stock_code,
            w.created_at,
            s.stock_name,
            s.current_price,
            s.market_type,
            s.country
        FROM watchlist w
        LEFT JOIN stock s ON w.stock_code = s.stock_code
        WHERE w.watchlist_id = #{watchlistId}
    </select>

    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         관심종목 ID로 삭제
         ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    
    <delete id="deleteById" parameterType="long">
        DELETE FROM watchlist 
        WHERE watchlist_id = #{watchlistId}
    </delete>

    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         회원의 모든 관심종목 삭제
         ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    
    <delete id="deleteAllByMemberId" parameterType="string">
        DELETE FROM watchlist 
        WHERE member_id = #{memberId}
    </delete>

</mapper>
