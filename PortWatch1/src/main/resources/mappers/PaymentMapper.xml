<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  ══════════════════════════════════════════════════════════════
  PaymentMapper.xml - 신규
  
  총 15개 쿼리
  Toss Payments (한국) + Stripe (미국) 연동
  ══════════════════════════════════════════════════════════════
-->
<mapper namespace="com.portwatch.mapper.PaymentMapper">

    <resultMap id="PaymentResultMap" type="com.portwatch.domain.PaymentVO">
        <id property="paymentId" column="payment_id"/>
        <result property="memberId" column="member_id"/>
        <result property="stockId" column="stock_id"/>
        <result property="stockCode" column="stock_code"/>
        <result property="stockName" column="stock_name"/>
        <result property="quantity" column="quantity"/>
        <result property="purchasePrice" column="purchase_price"/>
        <result property="totalAmount" column="total_amount"/>
        <result property="paymentMethod" column="payment_method"/>
        <result property="cardNumber" column="card_number"/>
        <result property="cardCompany" column="card_company"/>
        <result property="pgProvider" column="pg_provider"/>
        <result property="transactionId" column="transaction_id"/>
        <result property="status" column="status"/>
        <result property="country" column="country"/>
        <result property="currency" column="currency"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 1. insert - 결제 등록 -->
    <insert id="insert" parameterType="com.portwatch.domain.PaymentVO" 
            useGeneratedKeys="true" keyProperty="paymentId">
        INSERT INTO PAYMENT (
            member_id, stock_id, stock_code, stock_name, quantity,
            purchase_price, total_amount, payment_method, card_number,
            card_company, pg_provider, status, country, currency, created_at
        ) VALUES (
            #{memberId}, #{stockId}, #{stockCode}, #{stockName}, #{quantity},
            #{purchasePrice}, #{totalAmount}, #{paymentMethod}, #{cardNumber},
            #{cardCompany}, #{pgProvider}, #{status}, #{country}, #{currency}, NOW()
        )
    </insert>

    <!-- 2. findById - 결제 ID 조회 -->
    <select id="findById" parameterType="long" resultMap="PaymentResultMap">
        SELECT * FROM PAYMENT WHERE payment_id = #{paymentId}
    </select>

    <!-- 3. findByMemberId - 회원 결제 내역 -->
    <select id="findByMemberId" parameterType="string" resultMap="PaymentResultMap">
        SELECT * FROM PAYMENT 
        WHERE member_id = #{memberId}
        ORDER BY created_at DESC
    </select>

    <!-- 4. findByDateRange - 기간별 조회 -->
    <select id="findByDateRange" resultMap="PaymentResultMap">
        SELECT * FROM PAYMENT
        WHERE member_id = #{memberId}
          AND created_at BETWEEN #{startDate} AND #{endDate}
        ORDER BY created_at DESC
    </select>

    <!-- 5. updateStatus - 상태 업데이트 -->
    <update id="updateStatus">
        UPDATE PAYMENT
        SET status = #{status},
            updated_at = NOW()
        WHERE payment_id = #{paymentId}
    </update>

    <!-- 6. updateTransactionId - 거래 ID 업데이트 -->
    <update id="updateTransactionId">
        UPDATE PAYMENT
        SET transaction_id = #{transactionId},
            updated_at = NOW()
        WHERE payment_id = #{paymentId}
    </update>

    <!-- 7. delete - 결제 삭제 -->
    <delete id="delete" parameterType="long">
        DELETE FROM PAYMENT WHERE payment_id = #{paymentId}
    </delete>

    <!-- 8. getTotalAmount - 총 결제액 -->
    <select id="getTotalAmount" parameterType="string" resultType="decimal">
        SELECT COALESCE(SUM(total_amount), 0) 
        FROM PAYMENT 
        WHERE member_id = #{memberId} 
          AND status = 'COMPLETED'
    </select>

    <!-- 9. countByMemberId - 결제 건수 -->
    <select id="countByMemberId" parameterType="string" resultType="int">
        SELECT COUNT(*) 
        FROM PAYMENT 
        WHERE member_id = #{memberId}
    </select>

    <!-- 10. findRecent - 최근 결제 -->
    <select id="findRecent" resultMap="PaymentResultMap">
        SELECT * FROM PAYMENT
        WHERE member_id = #{memberId}
        ORDER BY created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 11. findByStatus - 상태별 조회 -->
    <select id="findByStatus" resultMap="PaymentResultMap">
        SELECT * FROM PAYMENT
        WHERE member_id = #{memberId} AND status = #{status}
        ORDER BY created_at DESC
    </select>

    <!-- 12. findByStockCode - 종목별 결제 -->
    <select id="findByStockCode" resultMap="PaymentResultMap">
        SELECT * FROM PAYMENT
        WHERE stock_code = #{stockCode}
        ORDER BY created_at DESC
    </select>

    <!-- 13. countByStatus - 상태별 건수 -->
    <select id="countByStatus" resultType="int">
        SELECT COUNT(*) 
        FROM PAYMENT 
        WHERE member_id = #{memberId} AND status = #{status}
    </select>

    <!-- 14. findByCountry - 국가별 결제 -->
    <select id="findByCountry" resultMap="PaymentResultMap">
        SELECT * FROM PAYMENT
        WHERE member_id = #{memberId} AND country = #{country}
        ORDER BY created_at DESC
    </select>

    <!-- 15. getPaymentSummary - 결제 요약 -->
    <select id="getPaymentSummary" parameterType="string" resultType="map">
        SELECT 
            COUNT(*) as total_count,
            SUM(total_amount) as total_amount,
            AVG(total_amount) as avg_amount,
            COUNT(CASE WHEN status = 'COMPLETED' THEN 1 END) as completed_count,
            COUNT(CASE WHEN status = 'CANCELLED' THEN 1 END) as cancelled_count,
            COUNT(CASE WHEN status = 'PENDING' THEN 1 END) as pending_count
        FROM PAYMENT
        WHERE member_id = #{memberId}
    </select>

</mapper>
