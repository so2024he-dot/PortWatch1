<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.portwatch.persistence.WatchlistDAO">

    <!-- ========================================
         ResultMap 정의
         ======================================== -->
    
    <!-- 기본 WatchlistVO -->
    <resultMap id="WatchlistResultMap" type="WatchlistVO">
        <id property="watchlistId" column="watchlist_id"/>
        <result property="memberId" column="member_id"/>
        <result property="stockId" column="stock_id"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>
    
    <!-- ✅ 가격 포함 WatchlistWithPriceVO -->
    <resultMap id="WatchlistWithPriceResultMap" type="WatchlistWithPriceVO">
        <id property="watchlistId" column="watchlist_id"/>
        <result property="memberId" column="member_id"/>
        <result property="stockId" column="stock_id"/>
        <result property="createdAt" column="created_at"/>
        <!-- 종목 정보 -->
        <result property="stockCode" column="stock_code"/>
        <result property="stockName" column="stock_name"/>
        <result property="marketType" column="market_type"/>
        <result property="country" column="country"/>
        <result property="industry" column="industry"/>
        <!-- 가격 정보 -->
        <result property="currentPrice" column="current_price"/>
        <result property="priceChange" column="price_change"/>
        <result property="priceChangeRate" column="price_change_rate"/>
        <result property="volume" column="volume"/>
    </resultMap>

    <!-- ========================================
         기본 CRUD
         ======================================== -->
    
    <!-- 관심종목 추가 -->
    <insert id="insertWatchlist" parameterType="WatchlistVO">
        INSERT INTO watchlist (
            member_id,
            stock_id,
            created_at
        ) VALUES (
            #{memberId},
            #{stockId},
            NOW()
        )
    </insert>
    
    <!-- ID로 조회 -->
    <select id="selectById" parameterType="int" resultMap="WatchlistResultMap">
        SELECT 
            watchlist_id,
            member_id,
            stock_id,
            created_at
        FROM watchlist
        WHERE watchlist_id = #{watchlistId}
    </select>
    
    <!-- 회원의 관심종목 목록 조회 (기본) -->
    <select id="selectWatchlistByMember" parameterType="string" resultMap="WatchlistResultMap">
        SELECT 
            watchlist_id,
            member_id,
            stock_id,
            created_at
        FROM watchlist
        WHERE member_id = #{memberId}
        ORDER BY created_at DESC
    </select>
    
    <!-- 관심종목 존재 여부 확인 -->
    <select id="checkExists" resultType="int">
        SELECT COUNT(*)
        FROM watchlist
        WHERE member_id = #{memberId}
          AND stock_id = #{stockId}
    </select>
    
    <!-- 관심종목 삭제 (memberId, stockId 사용) -->
    <delete id="deleteWatchlistByMemberAndStock">
        DELETE FROM watchlist
        WHERE member_id = #{memberId}
          AND stock_id = #{stockId}
    </delete>
    
    <!-- 관심종목 삭제 (watchlistId 사용) -->
    <delete id="deleteWatchlistById" parameterType="int">
        DELETE FROM watchlist
        WHERE watchlist_id = #{watchlistId}
    </delete>
    
    <!-- 회원의 모든 관심종목 삭제 -->
    <delete id="deleteAllWatchlistByMember" parameterType="string">
        DELETE FROM watchlist
        WHERE member_id = #{memberId}
    </delete>

    <!-- ========================================
         ✅ 가격 정보 포함 조회 (신규!)
         ======================================== -->
    
    <!-- 회원의 관심종목 목록 + 현재가 -->
    <select id="selectWatchlistWithPrices" parameterType="string" resultMap="WatchlistWithPriceResultMap">
        SELECT 
            w.watchlist_id,
            w.member_id,
            w.stock_id,
            w.created_at,
            s.stock_code,
            s.stock_name,
            s.market_type,
            s.country,
            s.industry,
            s.current_price,
            s.price_change,
            s.price_change_rate,
            s.volume
        FROM watchlist w
        INNER JOIN stock s ON w.stock_id = s.stock_id
        WHERE w.member_id = #{memberId}
        ORDER BY w.created_at DESC
    </select>
    
    <!-- 특정 관심종목 + 현재가 -->
    <select id="selectWatchlistWithPriceById" parameterType="int" resultMap="WatchlistWithPriceResultMap">
        SELECT 
            w.watchlist_id,
            w.member_id,
            w.stock_id,
            w.created_at,
            s.stock_code,
            s.stock_name,
            s.market_type,
            s.country,
            s.industry,
            s.current_price,
            s.price_change,
            s.price_change_rate,
            s.volume
        FROM watchlist w
        INNER JOIN stock s ON w.stock_id = s.stock_id
        WHERE w.watchlist_id = #{watchlistId}
    </select>

    <!-- ========================================
         통계 쿼리
         ======================================== -->
    
    <!-- 관심종목 개수 -->
    <select id="countWatchlist" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM watchlist
        WHERE member_id = #{memberId}
    </select>

</mapper>
