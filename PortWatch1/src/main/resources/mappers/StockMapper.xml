<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.portwatch.persistence.StockDAO">

    <!-- ========================================
         ✅ ResultMap 정의 (중복 제거!)
         ======================================== -->
    
    <resultMap id="StockResultMap" type="StockVO">
        <id property="stockId" column="stock_id"/>
        <result property="stockCode" column="stock_code"/>
        <result property="stockName" column="stock_name"/>
        <result property="marketType" column="market_type"/>
        <result property="country" column="country"/>
        <result property="industry" column="industry"/>
        <result property="currentPrice" column="current_price"/>
        <result property="priceChange" column="price_change"/>
        <result property="priceChangeRate" column="price_change_rate"/>
        <result property="volume" column="volume"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- ========================================
         기본 CRUD
         ======================================== -->
    
    <!-- 종목 코드로 조회 (StockVO 전체 반환) -->
    <select id="selectStockByCode" parameterType="string" resultMap="StockResultMap">
        SELECT 
            stock_id, stock_code, stock_name, market_type,
            country, industry, current_price, price_change,
            price_change_rate, volume, created_at, updated_at
        FROM stock 
        WHERE stock_code = #{stockCode}
    </select>
    
    <!-- 종목 코드로 조회 (별칭) -->
    <select id="selectByCode" parameterType="string" resultMap="StockResultMap">
        SELECT 
            stock_id, stock_code, stock_name, market_type,
            country, industry, current_price, price_change,
            price_change_rate, volume, created_at, updated_at
        FROM stock 
        WHERE stock_code = #{stockCode}
    </select>
    
    <!-- 종목 ID로 조회 -->
    <select id="selectStockById" parameterType="int" resultMap="StockResultMap">
        SELECT 
            stock_id, stock_code, stock_name, market_type,
            country, industry, current_price, price_change,
            price_change_rate, volume, created_at, updated_at
        FROM stock 
        WHERE stock_id = #{stockId}
    </select>
    
    <!-- 전체 종목 조회 -->
    <select id="selectAllStocks" resultMap="StockResultMap">
        SELECT 
            stock_id, stock_code, stock_name, market_type,
            country, industry, current_price, price_change,
            price_change_rate, volume, created_at, updated_at
        FROM stock
        ORDER BY stock_name
    </select>

    <!-- ========================================
         필터링 쿼리
         ======================================== -->
    
    <!-- 나라별 조회 -->
    <select id="selectStocksByCountry" parameterType="string" resultMap="StockResultMap">
        SELECT 
            stock_id, stock_code, stock_name, market_type,
            country, industry, current_price, price_change,
            price_change_rate, volume, created_at, updated_at
        FROM stock
        WHERE country = #{country}
        ORDER BY stock_name
    </select>
    
    <!-- 시장별 조회 -->
    <select id="selectStocksByMarketType" parameterType="string" resultMap="StockResultMap">
        SELECT 
            stock_id, stock_code, stock_name, market_type,
            country, industry, current_price, price_change,
            price_change_rate, volume, created_at, updated_at
        FROM stock
        WHERE market_type = #{marketType}
        ORDER BY stock_name
    </select>
    
    <!-- 업종별 조회 -->
    <select id="selectStocksByIndustry" parameterType="string" resultMap="StockResultMap">
        SELECT 
            stock_id, stock_code, stock_name, market_type,
            country, industry, current_price, price_change,
            price_change_rate, volume, created_at, updated_at
        FROM stock
        WHERE industry = #{industry}
        ORDER BY stock_name
    </select>
    
    <!-- 검색 (종목명 또는 종목코드) -->
    <select id="searchStocks" parameterType="string" resultMap="StockResultMap">
        SELECT 
            stock_id, stock_code, stock_name, market_type,
            country, industry, current_price, price_change,
            price_change_rate, volume, created_at, updated_at
        FROM stock
        WHERE stock_name LIKE CONCAT('%', #{keyword}, '%')
           OR stock_code LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY stock_name
        LIMIT 50
    </select>

    <!-- ========================================
         정렬 쿼리
         ======================================== -->
    
    <!-- 거래량 상위 종목 -->
    <select id="selectStocksOrderByVolume" parameterType="int" resultMap="StockResultMap">
        SELECT 
            stock_id, stock_code, stock_name, market_type,
            country, industry, current_price, price_change,
            price_change_rate, volume, created_at, updated_at
        FROM stock
        WHERE volume IS NOT NULL
        ORDER BY volume DESC
        LIMIT #{limit}
    </select>
    
    <!-- 등락률 상위 종목 -->
    <select id="selectStocksOrderByChangeRate" parameterType="int" resultMap="StockResultMap">
        SELECT 
            stock_id, stock_code, stock_name, market_type,
            country, industry, current_price, price_change,
            price_change_rate, volume, created_at, updated_at
        FROM stock
        WHERE price_change_rate IS NOT NULL
        ORDER BY price_change_rate DESC
        LIMIT #{limit}
    </select>

    <!-- ========================================
         업종 목록
         ======================================== -->
    
    <!-- 전체 업종 목록 조회 -->
    <select id="selectAllIndustries" resultType="string">
        SELECT DISTINCT industry
        FROM stock
        WHERE industry IS NOT NULL
        ORDER BY industry
    </select>

    <!-- ========================================
         데이터 수정
         ======================================== -->
    
    <!-- 종목 정보 업데이트 -->
    <update id="updateStock" parameterType="StockVO">
        UPDATE stock
        SET stock_name = #{stockName},
            market_type = #{marketType},
            country = #{country},
            industry = #{industry},
            current_price = #{currentPrice},
            price_change = #{priceChange},
            price_change_rate = #{priceChangeRate},
            volume = #{volume},
            updated_at = NOW()
        WHERE stock_code = #{stockCode}
    </update>
    
    <!-- 가격 정보만 업데이트 -->
    <update id="updateStockPrice" parameterType="map">
        UPDATE stock
        SET current_price = #{currentPrice},
            price_change = #{priceChange},
            price_change_rate = #{priceChangeRate},
            volume = #{volume},
            updated_at = NOW()
        WHERE stock_code = #{stockCode}
    </update>

    <!-- ========================================
         데이터 삽입
         ======================================== -->
    
    <!-- 새 종목 추가 -->
    <insert id="insertStock" parameterType="StockVO">
        INSERT INTO stock (
            stock_code, stock_name, market_type, country,
            industry, current_price, price_change,
            price_change_rate, volume, created_at, updated_at
        ) VALUES (
            #{stockCode}, #{stockName}, #{marketType}, #{country},
            #{industry}, #{currentPrice}, #{priceChange},
            #{priceChangeRate}, #{volume}, NOW(), NOW()
        )
    </insert>

    <!-- ========================================
         통계 쿼리
         ======================================== -->
    
    <!-- 전체 종목 수 -->
    <select id="countAllStocks" resultType="int">
        SELECT COUNT(*) FROM stock
    </select>
    
    <!-- 나라별 종목 수 -->
    <select id="countStocksByCountry" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM stock WHERE country = #{country}
    </select>

</mapper>
