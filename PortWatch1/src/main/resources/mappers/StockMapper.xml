<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    ══════════════════════════════════════════════════════════════
    StockMapper.xml
    ══════════════════════════════════════════════════════════════
    [유지] 기존 ResultMap, insert, select, update, delete, 통계 쿼리
           → 기존 다른 파일의 어노테이션/참조 100% 호환
    [추가] ★ insertCrawl  : 크롤링 전용 INSERT (crawlStockId 사용)
           ★ deleteByCountry : 크롤링 전 국가별 기존 데이터 삭제
    ══════════════════════════════════════════════════════════════
-->
<mapper namespace="com.portwatch.mapper.StockMapper">

    <!-- ════════════════════════════════════════════════════════
         [기존 유지] ResultMap - 원본 100% 보존
         ════════════════════════════════════════════════════════ -->
    <resultMap id="StockResultMap" type="com.portwatch.domain.StockVO">
        <id     property="stockId"       column="stock_id"/>
        <result property="stockCode"     column="stock_code"/>
        <result property="stockName"     column="stock_name"/>
        <result property="market"        column="market"/>
        <result property="country"       column="country"/>
        <result property="currentPrice"  column="current_price"/>
        <result property="previousClose" column="previous_close"/>
        <result property="changeAmount"  column="change_amount"/>
        <result property="changeRate"    column="change_rate"/>
        <result property="volume"        column="volume"/>
        <result property="createdAt"     column="created_at"/>
        <result property="updatedAt"     column="updated_at"/>
    </resultMap>

    <!-- ════════════════════════════════════════════════════════
         [기존 유지] INSERT - 원본 100% 보존
         기존 다른 파일에서 stockMapper.insert(stock) 호출 시 그대로 작동
         ════════════════════════════════════════════════════════ -->
    <insert id="insert" parameterType="com.portwatch.domain.StockVO">
        INSERT INTO STOCK (
            stock_id,
            stock_code,
            stock_name,
            market,
            country,
            current_price,
            previous_close,
            change_amount,
            change_rate,
            volume
        ) VALUES (
            #{stockId},
            #{stockCode},
            #{stockName},
            #{market},
            #{country},
            #{currentPrice},
            #{previousClose},
            #{changeAmount},
            #{changeRate},
            #{volume}
        )
    </insert>

    <!-- ════════════════════════════════════════════════════════
         ★ [신규 추가] insertCrawl - 크롤링 전용
         기존 insert 와 별도 존재 → 충돌 없음
         crawlStockId(String) → stock_id(VARCHAR 50) 에 저장
         ON DUPLICATE KEY UPDATE: 중복 stock_id 시 가격 업데이트
         ════════════════════════════════════════════════════════ -->
    <insert id="insertCrawl" parameterType="com.portwatch.domain.StockVO">
        INSERT INTO STOCK (
            stock_id,
            stock_code,
            stock_name,
            market,
            country,
            current_price,
            previous_close,
            change_amount,
            change_rate,
            volume
        ) VALUES (
            #{crawlStockId},
            #{stockCode},
            #{stockName},
            #{market},
            #{country},
            #{currentPrice},
            #{previousClose},
            #{changeAmount},
            #{changeRate},
            #{volume}
        )
        ON DUPLICATE KEY UPDATE
            stock_name     = VALUES(stock_name),
            market         = VALUES(market),
            current_price  = VALUES(current_price),
            previous_close = VALUES(previous_close),
            change_amount  = VALUES(change_amount),
            change_rate    = VALUES(change_rate),
            volume         = VALUES(volume),
            updated_at     = CURRENT_TIMESTAMP
    </insert>

    <!-- ════════════════════════════════════════════════════════
         [기존 유지] SELECT - 원본 100% 보존
         ════════════════════════════════════════════════════════ -->

    <!-- 종목 코드로 조회 -->
    <select id="findByCode" resultMap="StockResultMap">
        SELECT * FROM STOCK
        WHERE stock_code = #{stockCode}
    </select>

    <!-- 종목 ID로 조회 -->
    <select id="findById" resultMap="StockResultMap">
        SELECT * FROM STOCK
        WHERE stock_id = #{stockId}
    </select>

    <!-- 모든 종목 조회 -->
    <select id="findAll" resultMap="StockResultMap">
        SELECT
            stock_id,
            stock_code,
            stock_name,
            market,
            country,
            current_price,
            previous_close,
            change_amount,
            change_rate,
            volume,
            created_at,
            updated_at
        FROM STOCK
        ORDER BY
            country,
            market,
            stock_code
    </select>

    <!-- 국가별 종목 조회 -->
    <select id="findByCountry" resultMap="StockResultMap">
        SELECT * FROM STOCK
        WHERE country = #{country}
        ORDER BY stock_code
    </select>

    <!-- 시장별 종목 조회 -->
    <select id="findByMarket" resultMap="StockResultMap">
        SELECT * FROM STOCK
        WHERE market = #{market}
        ORDER BY stock_code
    </select>

    <!-- 종목 검색 -->
    <select id="searchStocks" resultMap="StockResultMap">
        SELECT * FROM STOCK
        WHERE stock_code LIKE CONCAT('%', #{keyword}, '%')
           OR stock_name  LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY stock_code
        LIMIT 50
    </select>

    <!-- ════════════════════════════════════════════════════════
         [기존 유지] UPDATE - 원본 100% 보존
         ════════════════════════════════════════════════════════ -->

    <!-- 종목 정보 수정 -->
    <update id="update" parameterType="com.portwatch.domain.StockVO">
        UPDATE STOCK
        SET
            stock_name = #{stockName},
            market     = #{market},
            country    = #{country},
            updated_at = CURRENT_TIMESTAMP
        WHERE stock_id = #{stockId}
    </update>

    <!-- 주가 정보 업데이트 -->
    <update id="updatePrice" parameterType="com.portwatch.domain.StockVO">
        UPDATE STOCK
        SET
            current_price  = #{currentPrice},
            previous_close = #{previousClose},
            change_amount  = #{changeAmount},
            change_rate    = #{changeRate},
            volume         = #{volume},
            updated_at     = CURRENT_TIMESTAMP
        WHERE stock_id = #{stockId}
    </update>

    <!-- ════════════════════════════════════════════════════════
         [기존 유지] DELETE - 원본 100% 보존
         ════════════════════════════════════════════════════════ -->

    <!-- 종목 삭제 -->
    <delete id="delete">
        DELETE FROM STOCK
        WHERE stock_id = #{stockId}
    </delete>

    <!-- ★ [신규 추가] 국가별 전체 삭제 (크롤링 전 초기화) -->
    <delete id="deleteByCountry" parameterType="String">
        DELETE FROM STOCK
        WHERE country = #{country}
    </delete>

    <!-- ════════════════════════════════════════════════════════
         [기존 유지] 통계 쿼리 - 원본 100% 보존
         ════════════════════════════════════════════════════════ -->

    <!-- 총 종목 수 -->
    <select id="count" resultType="int">
        SELECT COUNT(*) FROM STOCK
    </select>

    <!-- 국가별 종목 수 -->
    <select id="countByCountry" resultType="map">
        SELECT
            country,
            COUNT(*) as count
        FROM STOCK
        GROUP BY country
    </select>

</mapper>
